# Use Node.js 22 LTS Alpine for smaller image size and latest features
FROM node:22-alpine

# Install OpenSSL and netcat for Prisma compatibility and health checks
RUN apk add --no-cache openssl netcat-openbsd

# Set working directory
WORKDIR /app

# Install NestJS CLI globally
RUN npm install -g @nestjs/cli

# Copy package files first (for better layer caching)
COPY package*.json ./

# Copy Prisma schema (needed for postinstall prisma generate)
COPY prisma ./prisma

# Configure npm for better network resilience
RUN npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm config set fetch-retries 5 && \
    npm config set registry https://registry.npmjs.org/

# Install dependencies with cache mount for faster builds (this will run postinstall: prisma generate)
RUN --mount=type=cache,target=/root/.npm \
    npm install --legacy-peer-deps --no-audit --no-fund --prefer-offline

# Copy source code
COPY . .

# Create uploads directory for file service
RUN mkdir -p uploads

# Set OpenSSL environment variables for Prisma
ENV OPENSSL_CONF=/dev/null
ENV PRISMA_ENGINES_MIRROR=https://binaries.prisma.sh

# Expose port
EXPOSE 3013

# Development command with hot reload
CMD ["npm", "run", "start:dev"] 